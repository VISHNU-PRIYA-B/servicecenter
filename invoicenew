// @ts-nocheck
import React, { useState, useLayoutEffect, useEffect } from "react";
import {
  View,
  Text,
  TouchableOpacity,
  ScrollView,
  ActivityIndicator,
  StyleSheet,
  Linking,
  Modal,
  Alert,
} from "react-native";
import { graphqlRequest, BACKEND_BASE_URL } from "../services/api";
import { useLogout } from "../hooks/Logout";
import { useNavigation, useRoute } from "@react-navigation/native";
import { openWhatsApp } from "../utils/whatsapp";

export default function Invoice() {
  const navigation = useNavigation();
  const route = useRoute<any>();
  const logout = useLogout();

  //  requestId from UpdateStatus screen
  const requestId = route.params?.requestId;

  const [repairData, setRepairData] = useState<any>(null);
  const [totalAmount, setTotalAmount] = useState("");
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState("");
  const [pdfUrl, setPdfUrl] = useState("");
  const [showWhatsAppModal, setShowWhatsAppModal] = useState(false);

  useLayoutEffect(() => {
    navigation.setOptions({
      title: "Invoice",
      headerRight: () => (
        <TouchableOpacity onPress={logout} style={{ marginRight: 15 }}>
          <Text style={{ color: "red", fontWeight: "bold" }}>Logout</Text>
        </TouchableOpacity>
      ),
    });
  }, [navigation, logout]);

  const getInvoiceUrl = () => {
    if (!pdfUrl) return "";
    return pdfUrl.startsWith("/")
      ? BACKEND_BASE_URL + pdfUrl
      : pdfUrl;
  };


  const fetchDetails = async (id: string) => {
    setLoading(true);
    setMessage("");
    setRepairData(null);

    const query = `
      query ($requestId: String!) {
        repairRequest(requestId: $requestId) {
          requestId
          itemName
          problemDescription
          contactInfo
          estimation {
            total
            items {
              description
              quantity
              unitPrice
              amount
            }
          }
        }
      }
    `;

    try {
      const res = await graphqlRequest(query, { requestId: id });
      setRepairData(res?.repairRequest || null);
      setTotalAmount(String(res?.repairRequest?.estimation?.total || ""));
    } catch (err: any) {
      setMessage(err.message || "Failed to load invoice data");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (!requestId) {
      Alert.alert("Error", "Request ID missing");
      navigation.goBack();
      return;
    }
    fetchDetails(requestId);
  }, [requestId]);

  const generateInvoice = async () => {
    if (!requestId || !totalAmount) {
      Alert.alert("Missing request data");
      return;
    }

    setLoading(true);

    const mutation = `
      mutation ($requestId: String!, $totalAmount: Decimal!) {
        generateInvoice(requestId: $requestId, totalAmount: $totalAmount) {
          invoice {
            invoiceNumber
            pdfUrl
          }
        }
      }
    `;

    try {
      const response = await graphqlRequest(mutation, {
        requestId,
        totalAmount: Number(totalAmount),
      });

      const url = response?.generateInvoice?.invoice?.pdfUrl;
      if (!url) throw new Error("PDF URL not returned");

      setPdfUrl(url);
      setShowWhatsAppModal(true);
      setMessage("Invoice generated successfully!");
    } catch (err: any) {
      setMessage(err.message || "Invoice generation failed");
    } finally {
      setLoading(false);
    }
  };

  const openPdf = async () => {
    const finalUrl = getInvoiceUrl();
    if (!finalUrl) return;

    const supported = await Linking.canOpenURL(finalUrl);
    if (!supported) {
      Alert.alert("Error", "No app found to open PDF");
      return;
    }
    Linking.openURL(finalUrl);
  };

  return (
    <>
      {/* WHATSAPP MODAL */}
      <Modal transparent visible={showWhatsAppModal} animationType="fade">
        <View style={styles.modalBackground}>
          <View style={styles.modalBox}>
            <Text style={styles.modalTitle}>Invoice Generated</Text>

            <Text style={{ marginBottom: 15 }}>
              Do you want to send the invoice to the customer via WhatsApp?
            </Text>

            <TouchableOpacity
              style={styles.submitBtn}
              onPress={() => {
                setShowWhatsAppModal(false);
                openWhatsApp(
                  repairData?.contactInfo,
                  `ðŸ§¾ Invoice Generated

Request ID: ${repairData?.requestId}
Item: ${repairData?.itemName}
Total Amount: â‚¹${repairData?.estimation?.total}

ðŸ“„ Download Invoice:
${getInvoiceUrl()}

Thank you for choosing our service.`
                );
              }}
            >
              <Text style={styles.submitText}>Send WhatsApp</Text>
            </TouchableOpacity>

            <TouchableOpacity
              onPress={() => setShowWhatsAppModal(false)}
              style={styles.cancelButton}
            >
              <Text style={styles.cancelText}>Cancel</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>

      {/* MAIN CONTENT */}
      <ScrollView contentContainerStyle={styles.container}>
        {loading && <ActivityIndicator size="large" />}

        {repairData && (
          <>
            <Text style={styles.header}>INVOICE PREVIEW</Text>

            <Text>Customer: {repairData.contactInfo}</Text>
            <Text>Item: {repairData.itemName}</Text>
            <Text>Problem: {repairData.problemDescription}</Text>
            <Text>Request ID: {repairData.requestId}</Text>

            <View style={styles.line} />

            <Text style={styles.subHeader}>Estimation Items</Text>

            {repairData.estimation.items.map((item: any, i: number) => (
              <View key={i} style={styles.row}>
                <Text>{item.description}</Text>
                <Text>
                  {item.quantity} Ã— {item.unitPrice}
                </Text>
                <Text>â‚¹{item.amount}</Text>
              </View>
            ))}

            <View style={styles.line} />

            <Text style={styles.total}>
              Total: â‚¹{repairData.estimation.total}
            </Text>

            <TouchableOpacity
              onPress={generateInvoice}
              style={styles.button}
            >
              <Text style={styles.buttonText}>Generate Invoice</Text>
            </TouchableOpacity>

            {pdfUrl !== "" && (
              <TouchableOpacity style={styles.pdfButton} onPress={openPdf}>
                <Text style={styles.pdfButtonText}>View Invoice PDF</Text>
              </TouchableOpacity>
            )}
          </>
        )}

        {!!message && <Text style={styles.message}>{message}</Text>}
      </ScrollView>
    </>
  );
}

const styles = StyleSheet.create({
  container: { padding: 20 },
  header: { fontSize: 22, fontWeight: "bold", marginBottom: 10 },
  subHeader: { marginTop: 20, fontSize: 18, fontWeight: "bold" },

  row: {
    flexDirection: "row",
    justifyContent: "space-between",
    paddingVertical: 6,
  },

  total: { marginTop: 10, fontSize: 18, fontWeight: "bold" },

  button: {
    backgroundColor: "#3ff7baff",
    padding: 14,
    borderRadius: 8,
    alignItems: "center",
    marginVertical: 10,
  },
  buttonText: { fontWeight: "700", fontSize: 16 },

  pdfButton: {
    backgroundColor: "#4CAF50",
    padding: 12,
    borderRadius: 8,
    marginTop: 10,
    alignItems: "center",
  },
  pdfButtonText: { color: "#fff", fontWeight: "bold" },

  message: {
    marginTop: 15,
    textAlign: "center",
    fontWeight: "600",
  },

  line: {
    height: 1,
    backgroundColor: "#ddd",
    marginVertical: 12,
  },

  modalBackground: {
    flex: 1,
    justifyContent: "center",
    backgroundColor: "rgba(0,0,0,0.5)",
  },
  modalBox: {
    backgroundColor: "#fff",
    padding: 20,
    borderRadius: 12,
    marginHorizontal: 20,
  },
  modalTitle: { fontSize: 18, fontWeight: "bold", marginBottom: 10 },
  submitBtn: {
    backgroundColor: "#25D366",
    padding: 12,
    borderRadius: 8,
    marginBottom: 10,
  },
  submitText: { textAlign: "center", fontWeight: "bold" },
  cancelButton: {
    backgroundColor: "#999",
    padding: 10,
    borderRadius: 8,
  },
  cancelText: { textAlign: "center", color: "#fff", fontWeight: "bold" },
});
